<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>Real Estate Dashboard</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons for UI elements -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .kpi-card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; }
        .chart-card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; display: flex; justify-content: center; align-items: center; }
        @import url('https://rsms.me/inter/inter.css');
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 lg:p-8">
    <div id="loading" class="text-center text-gray-600">Loading Dashboard Data...</div>

    <div id="dashboardContent" class="hidden">
        <!-- Header -->
        <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Real Estate Dashboard</h1>
            <div class="text-right mt-2 sm:mt-0">
                <div id="dateTime" class="text-lg font-semibold text-gray-700"></div>
                <div class="text-sm text-gray-500">Sandton, Gauteng, South Africa</div>
            </div>
        </div>

        <!-- KPI Grid -->
        <div class="grid grid-cols-2 md:grid-cols-3 gap-6 mb-8">
            <div class="kpi-card">
                <h2 class="text-gray-500 text-sm font-medium">Total Properties</h2>
                <p id="totalProperties" class="text-3xl font-bold text-gray-900 mt-1">0</p>
            </div>
            <div class="kpi-card">
                <h2 class="text-gray-500 text-sm font-medium">Total Deals Done</h2>
                <p id="totalDeals" class="text-3xl font-bold text-gray-900 mt-1">0</p>
            </div>
            <div class="kpi-card">
                <h2 class="text-gray-500 text-sm font-medium">Total Commission</h2>
                <p id="totalCommission" class="text-3xl font-bold text-green-600 mt-1">R0.00</p>
            </div>
            <div class="kpi-card">
                <h2 class="text-gray-500 text-sm font-medium">Average Commission</h2>
                <p id="avgCommission" class="text-3xl font-bold text-blue-600 mt-1">R0.00</p>
            </div>
             <div class="kpi-card">
                <h2 class="text-gray-500 text-sm font-medium">Active Clients</h2>
                <p id="totalClients" class="text-3xl font-bold text-gray-900 mt-1">0</p>
            </div>
            <div class="kpi-card">
                <h2 class="text-gray-500 text-sm font-medium">Total Landlords</h2>
                <p id="totalLandlords" class="text-3xl font-bold text-gray-900 mt-1">0</p>
            </div>
        </div>

        <!-- Chart Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="chart-card lg:col-span-1"><canvas id="propertiesByTypeChart"></canvas></div>
            <div class="chart-card lg:col-span-1"><canvas id="saleVsLeaseChart"></canvas></div>
            <div class="chart-card lg:col-span-1"><canvas id="dealsByAreaChart"></canvas></div>
        </div>
    </div>
    
    <script>
        // Use a ZAR (South African Rand) currency formatter
        const zarFormatter = new Intl.NumberFormat('en-ZA', { style: 'currency', currency: 'ZAR' });

        // --- Live Clock Functionality ---
        function updateTime() {
            const dateTimeElement = document.getElementById('dateTime');
            if (dateTimeElement) {
                const now = new Date();
                const options = {
                    timeZone: 'Africa/Johannesburg',
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                };
                dateTimeElement.textContent = new Intl.DateTimeFormat('en-ZA', options).format(now);
            }
        }
        
        // Update the time every second
        setInterval(updateTime, 1000);

        // --- Dashboard Data Loading ---
        function loadDashboard() {
            google.script.run.withSuccessHandler(buildDashboard).withFailureHandler(showError).getDashboardData();
        }

        // This function runs if the data is fetched successfully
        function buildDashboard(data) {
            if (data.error) {
                showError({ message: data.error });
                return;
            }

            // --- Update KPIs ---
            document.getElementById('totalProperties').innerText = data.kpis.totalProperties;
            document.getElementById('totalDeals').innerText = data.kpis.totalDeals;
            document.getElementById('totalCommission').innerText = zarFormatter.format(data.kpis.totalCommission);
            document.getElementById('avgCommission').innerText = zarFormatter.format(data.kpis.avgCommission);
            
            // --- Update NEW KPIs ---
            // Note: Your Code.gs will need to be updated to provide these values.
            document.getElementById('totalClients').innerText = data.kpis.totalClients || 0;
            document.getElementById('totalLandlords').innerText = data.kpis.totalLandlords || 0;


            // --- Create Charts ---
            renderPieChart('propertiesByTypeChart', 'Properties by Type', data.charts.propertyTypes);
            renderPieChart('saleVsLeaseChart', 'Listing Type', data.charts.saleVsLease);
            renderBarChart('dealsByAreaChart', '# of Deals by Area', data.charts.dealsByArea);

            // Show the dashboard and hide the loading message
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboardContent').classList.remove('hidden');
        }

        // This function runs if an error occurs
        function showError(error) {
            document.getElementById('loading').innerText = 'Error: ' + error.message;
        }

        // Chart Rendering Functions
        function renderPieChart(canvasId, title, data) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: title,
                        data: Object.values(data),
                        backgroundColor: ['#3b82f6', '#10b981', '#f97316', '#ef4444', '#8b5cf6', '#f59e0b'],
                        hoverOffset: 4
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: title, font: { size: 16 } } } }
            });
        }

        function renderBarChart(canvasId, title, data) {
             const ctx = document.getElementById(canvasId).getContext('2d');
             new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: 'Deals',
                        data: Object.values(data),
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false }, title: { display: true, text: title, font: { size: 16 } } } }
             });
        }
        
        // Start loading the dashboard data once the page is ready
        document.addEventListener('DOMContentLoaded', (event) => {
            updateTime(); // Initial call to display time immediately
            loadDashboard();
        });
    </script>
</body>
</html>